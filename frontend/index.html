<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>築地ビンゴ</title>
<style>

:root {
  --gap: 6px;
  --primary: #cc0000;       /* アクセントカラー */
  --bg: #f9f9fb;            /* ページ背景 */
  --cell-bg: #ffffff;       /* マス背景 */
  --cell-marked: #ffecec;   /* マーク済み背景 */
}

body {
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
  margin: 8px;
  background: var(--bg);
  color: #333;
}

header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}
header h1 {
  font-size: 20px;
  font-weight: 700;
  background: linear-gradient(90deg, #cc0000, #ff6600);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
.muted {
  color: #666;
  font-size: 12px;
}

button {
  padding: 6px 12px;
  border: none;
  border-radius: 6px;
  background: linear-gradient(135deg, #ff6666, #cc0000);
  color: #fff;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 2px 5px rgba(0,0,0,0.15);
  transition: transform 0.1s ease, box-shadow 0.1s ease;
}
button:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.grid {
  display: grid;
  grid-template-columns: repeat(5, minmax(0, 1fr));
  gap: var(--gap);
  width: 100%;
  max-width: 100vw;
  margin: 0 auto;
}

.cell {
  position: relative;
  border: 1px solid #ddd;
  border-radius: 10px;
  background: var(--cell-bg);
  cursor: pointer;
  aspect-ratio: 1 / 1;
  width: 100%;
  box-sizing: border-box;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 4px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  /* ← transformをtransition対象から外す */
  transition: background 0.2s ease, box-shadow 0.2s ease;
}

.cell p {
  margin: 0;
  font-size: 10px;
  line-height: 1.2;
  word-break: break-word;
}

.cell.marked {
  background: var(--cell-marked);
  border: 1px solid var(--primary);
}

.cell:hover {
  /* transformをやめて揺れを防ぐ */
  box-shadow: 0 3px 8px rgba(0,0,0,0.2);
  background: #fefefe;  /* hover時に少し明るく */
}

.cell:active {
  /* スマホタップ時の視覚フィードバック */
  background: #f0f0f0;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2) inset;
}
.hole {
  position: absolute;
  inset: 6px;
  border: 3px solid var(--primary);
  border-radius: 8px;
  pointer-events: none;
  opacity: 0.9;
}
</style>
</head>
<body>
  <header>
    <h1 style="margin:0">築地ビンゴ</h1>
    <span id="gid" class="muted"></span>
    <button id="copy">URLをコピー</button>
    <span id="status" class="muted"></span>
  </header>
  <div id="grid" class="grid"></div>
<script>
const API_BASE = "https://06zthxtipi.execute-api.ap-northeast-1.amazonaws.com"; // 例: https://abc123.execute-api.ap-northeast-1.amazonaws.com
const DEFAULT_GAME_ID = "tsukiji-2025";
const params = new URLSearchParams(location.search);
const gameId = params.get("id") || DEFAULT_GAME_ID;
document.getElementById('gid').textContent = `#${gameId}`;

let labels = [];
let marks = new Array(25).fill(0);
let updating = false;

function cellHtml(text, i){
  const marked = marks[i] === 1;
  return `<div class="cell ${marked ? 'marked':''}" data-i="${i}">
    <p>${text.replaceAll('<','&lt;').replaceAll('>','&gt;')}</p>
    ${marked ? '<div class="hole"></div>' : ''}
  </div>`;
}

async function fetchState(){
  try{
    const r = await fetch(`${API_BASE}/games/${gameId}`);
    const j = await r.json();
    labels = j.labels; marks = j.marks;
    render();
  }catch(e){
    console.error(e);
    document.getElementById('status').textContent = '接続エラー';
  }
}

async function toggle(i){
  if(updating) return; updating = true;
  try{
    const r = await fetch(`${API_BASE}/games/${gameId}/toggle`,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({index:i})
    });
    const j = await r.json();
    marks = j.marks; render();
  }catch(e){ console.error(e); }
  finally{ updating = false; }
}

function render() {
  const grid = document.getElementById('grid');
  
  if (grid.children.length === 25) {
    // 既存DOMを更新するだけ
    [...grid.children].forEach((el, i) => {
      if (marks[i] === 1) {
        el.classList.add('marked');
        if (!el.querySelector('.hole')) {
          el.insertAdjacentHTML("beforeend", '<div class="hole"></div>');
        }
      } else {
        el.classList.remove('marked');
        const hole = el.querySelector('.hole');
        if (hole) hole.remove();
      }
    });
  } else {
    // 初期生成（1回だけ走る）
    grid.innerHTML = labels.map((t, i) =>
      `<div class="cell" data-i="${i}"><p>${t}</p></div>`
    ).join('');
    for (const el of grid.querySelectorAll('.cell')) {
      el.onclick = () => toggle(parseInt(el.dataset.i));
    }
  }
}

document.getElementById('copy').onclick = async ()=>{
  const url = `${location.origin}${location.pathname}?id=${encodeURIComponent(gameId)}`;
  await navigator.clipboard.writeText(url);
  document.getElementById('status').textContent = 'URLをコピー済み';
}

fetchState();
setInterval(fetchState, 300); // ざっくり同期
</script>
</body>
</html>