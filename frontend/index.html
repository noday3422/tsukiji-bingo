<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>築地ビンゴ</title>
<style>
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; margin: 16px; }
  .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; max-width: 900px; }
  .cell { position: relative; border: 1px solid #aaa; border-radius: 10px; padding: 10px; min-height: 120px; cursor: pointer; background: #fff; }
  .cell p { margin: 0; font-size: 14px; line-height: 1.4; }
  .cell.marked { background: #f4f4f4; }
  .hole { position: absolute; inset: 10px; border: 4px solid #cc0000; border-radius: 12px; pointer-events: none; opacity: 0.95; }
  header { display:flex; align-items:center; gap:8px; margin-bottom:12px; flex-wrap: wrap; }
  .muted { color:#666; font-size: 12px; }
  button { padding:6px 10px; }
</style>
</head>
<body>
  <header>
    <h1 style="margin:0">築地ビンゴ</h1>
    <span id="gid" class="muted"></span>
    <button id="copy">URLをコピー</button>
    <span id="status" class="muted"></span>
  </header>
  <div id="grid" class="grid"></div>
<script>
const API_BASE = "https://06zthxtipi.execute-api.ap-northeast-1.amazonaws.com"; // 例: https://abc123.execute-api.ap-northeast-1.amazonaws.com
const DEFAULT_GAME_ID = "tsukiji-2025";
const params = new URLSearchParams(location.search);
const gameId = params.get("id") || DEFAULT_GAME_ID;
document.getElementById('gid').textContent = `#${gameId}`;

let labels = [];
let marks = new Array(25).fill(0);
let updating = false;

function cellHtml(text, i){
  const marked = marks[i] === 1;
  return `<div class="cell ${marked ? 'marked':''}" data-i="${i}">
    <p>${text.replaceAll('<','&lt;').replaceAll('>','&gt;')}</p>
    ${marked ? '<div class="hole"></div>' : ''}
  </div>`;
}

async function fetchState(){
  try{
    const r = await fetch(`${API_BASE}/games/${gameId}`);
    const j = await r.json();
    labels = j.labels; marks = j.marks;
    render();
  }catch(e){
    console.error(e);
    document.getElementById('status').textContent = '接続エラー';
  }
}

async function toggle(i){
  if(updating) return; updating = true;
  try{
    const r = await fetch(`${API_BASE}/games/${gameId}/toggle`,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({index:i})
    });
    const j = await r.json();
    marks = j.marks; render();
  }catch(e){ console.error(e); }
  finally{ updating = false; }
}

function render(){
  const grid = document.getElementById('grid');
  grid.innerHTML = labels.map((t, i)=>cellHtml(t, i)).join('');
  for(const el of grid.querySelectorAll('.cell')){
    el.onclick = ()=> toggle(parseInt(el.dataset.i));
  }
  document.getElementById('status').textContent = new Date().toLocaleTimeString('ja-JP') + ' 更新';
}

document.getElementById('copy').onclick = async ()=>{
  const url = `${location.origin}${location.pathname}?id=${encodeURIComponent(gameId)}`;
  await navigator.clipboard.writeText(url);
  document.getElementById('status').textContent = 'URLをコピー済み';
}

fetchState();
setInterval(fetchState, 500); // ざっくり同期
</script>
</body>
</html>