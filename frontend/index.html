<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>築地ビンゴ</title>
<style>
:root {
  --gap: 6px;
  --primary: #005bac;   /* ベイスターズブルー */
  --bg: #e6f0fa;        /* 薄い空色背景 */
  --cell-bg: #ffffff;   /* 白 */
  --cell-marked: #dceeff; /* 淡いブルー */
  --title-gradient: linear-gradient(90deg, #005bac, #00aaff);
  --button-bg: linear-gradient(135deg, #3399ff, #005bac);
}

body {
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
  margin: 8px;
  background: var(--bg);
  color: #333;
}

header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}
header h1 {
  font-size: 20px;
  font-weight: 700;
  background: var(--title-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
.muted {
  color: #666;
  font-size: 12px;
}

button {
  padding: 6px 12px;
  border: none;
  border-radius: 6px;
  background: var(--button-bg);
  color: #fff;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 2px 5px rgba(0,0,0,0.15);
  transition: transform 0.1s ease, box-shadow 0.1s ease;
}
button:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.grid {
  display: grid;
  grid-template-columns: repeat(5, minmax(0, 1fr));
  gap: var(--gap);
  width: 100%;
  max-width: 100vw;
  margin: 0 auto;
}

.cell {
  position: relative;
  border: 1px solid #ddd;
  border-radius: 10px;
  background: var(--cell-bg);
  cursor: pointer;
  aspect-ratio: 1 / 1;
  width: 100%;
  box-sizing: border-box;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 4px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  transition: background 0.2s ease, box-shadow 0.2s ease;
}

.cell p {
  margin: 0;
  font-size: 10px;
  line-height: 1.2;
  word-break: break-word;
}

.cell.marked {
  border: 1px solid var(--primary);
}

.cell:hover {
  box-shadow: 0 3px 8px rgba(0,0,0,0.2);
  background: #fefefe;
}

.cell:active {
  background: #f0f0f0;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2) inset;
}

.hole {
  position: absolute;
  inset: 6px;
  border: 3px solid var(--primary);
  border-radius: 50%;
  pointer-events: none;
  opacity: 0.9;
}
</style>
</head>
<body>
  <header>
    <h1 style="margin:0">築地ビンゴ</h1>
    <span id="gid" class="muted"></span>
    <button id="copy">URLをコピー</button>
    <label for="theme">テーマ:</label>
    <select id="theme">
      <option value="baystars" selected>ベイスターズ</option>
      <option value="night">ナイト</option>
      <option value="starman">スターマン</option>
    </select>
    <span id="status" class="muted"></span>
  </header>
  <div id="grid" class="grid"></div>

<script>
const API_BASE = "https://06zthxtipi.execute-api.ap-northeast-1.amazonaws.com"; // Lambda APIのURL
const DEFAULT_GAME_ID = "tsukiji-2025";
const params = new URLSearchParams(location.search);
const gameId = params.get("id") || DEFAULT_GAME_ID;
document.getElementById('gid').textContent = `#${gameId}`;

let labels = [];
let marks = new Array(25).fill(0);
let updating = false;

function cellHtml(text, i){
  const marked = marks[i] === 1;
  return `<div class="cell ${marked ? 'marked':''}" data-i="${i}">
    <p>${text.replaceAll('<','&lt;').replaceAll('>','&gt;')}</p>
    ${marked ? '<div class="hole"></div>' : ''}
  </div>`;
}

async function fetchState(){
  try{
    const r = await fetch(`${API_BASE}/games/${gameId}`);
    const j = await r.json();
    labels = j.labels; marks = j.marks;
    render();
  }catch(e){
    console.error(e);
    document.getElementById('status').textContent = '接続エラー';
  }
}

async function toggle(i){
  if(updating) return; updating = true;
  try{
    const r = await fetch(`${API_BASE}/games/${gameId}/toggle`,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({index:i})
    });
    const j = await r.json();
    marks = j.marks; render();
  }catch(e){ console.error(e); }
  finally{ updating = false; }
}

function render(){
  const grid = document.getElementById('grid');
  if (grid.children.length === 25) {
    [...grid.children].forEach((el, i) => {
      if (marks[i] === 1) {
        el.classList.add('marked');
        if (!el.querySelector('.hole')) {
          el.insertAdjacentHTML("beforeend", '<div class="hole"></div>');
        }
      } else {
        el.classList.remove('marked');
        const hole = el.querySelector('.hole');
        if (hole) hole.remove();
      }
    });
  } else {
    grid.innerHTML = labels.map((t, i)=>cellHtml(t, i)).join('');
    for(const el of grid.querySelectorAll('.cell')){
      el.onclick = ()=> toggle(parseInt(el.dataset.i));
    }
  }
  document.getElementById('status').textContent = new Date().toLocaleTimeString('ja-JP') + ' 更新';
}

document.getElementById('copy').onclick = async ()=>{
  const url = `${location.origin}${location.pathname}?id=${encodeURIComponent(gameId)}`;
  await navigator.clipboard.writeText(url);
  document.getElementById('status').textContent = 'URLをコピー済み';
};

/* テーマ定義 */
const themes = {
  default: {
    "--primary": "#cc0000",
    "--bg": "#f9f9fb",
    "--cell-bg": "#ffffff",
    "--cell-marked": "#ffecec",
    "--title-gradient": "linear-gradient(90deg, #cc0000, #ff6600)",
    "--button-bg": "linear-gradient(135deg, #ff6666, #cc0000)"
  },
  baystars: {
    "--primary": "#005bac",
    "--bg": "#e6f0fa",
    "--cell-bg": "#ffffff",
    "--cell-marked": "#dceeff",
    "--title-gradient": "linear-gradient(90deg, #005bac, #00aaff)",
    "--button-bg": "linear-gradient(135deg, #3399ff, #005bac)"
  },
  night: {
    "--primary": "#002b5c",
    "--bg": "#f5f7fa",
    "--cell-bg": "#ffffff",
    "--cell-marked": "#cce5ff",
    "--title-gradient": "linear-gradient(90deg, #001f4d, #004080)",
    "--button-bg": "linear-gradient(135deg, #336699, #002b5c)"
  },
  starman: {
    "--primary": "#ff7f32",
    "--bg": "#fef6ef",
    "--cell-bg": "#ffffff",
    "--cell-marked": "#fff0e5",
    "--title-gradient": "linear-gradient(90deg, #ff7f32, #ffcc66)",
    "--button-bg": "linear-gradient(135deg, #ff9966, #ff7f32)"
  }
};

document.getElementById("theme").addEventListener("change", (e) => {
  const t = themes[e.target.value];
  for (const key in t) {
    document.documentElement.style.setProperty(key, t[key]);
  }
});

fetchState();
setInterval(fetchState, 300); // ポーリング間隔
</script>
</body>
</html>
